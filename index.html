<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local Delivery — Partner Dashboard</title>
  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet for simple map view -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* small extra styles */
    #map { height: 320px; border-radius: 0.5rem; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9)); }
    .chip { background:#eef2ff; color:#3730a3; padding:4px 8px; border-radius:999px; font-weight:600; }
    .tiny { font-size:0.8rem; color:#6b7280 }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between py-4">
      <div>
        <h1 class="text-2xl font-bold">Local Delivery — Partner Dashboard</h1>
        <p class="tiny">Connects nearby people and local partners to deliver parcels with low commissions.</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="chip">Commission: <span id="commissionLabel">5%</span></div>
        <button id="btnTogglePanel" class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Partner / Client Panel</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Left column: Map + Nearby -->
      <section class="md:col-span-2 space-y-4">
        <div class="card p-4 rounded shadow">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Map — Find Nearby Partners</h2>
            <div class="tiny">Example demo — no backend required</div>
          </div>
          <div id="map" class="mt-3"></div>
          <div class="mt-3 flex gap-2">
            <button id="btnLocate" class="px-3 py-2 rounded border">Use My Location</button>
            <input id="searchAddr" placeholder="Enter lat,lng (e.g. 12.9716,77.5946)" class="border rounded px-3 py-2 w-64" />
            <button id="btnSearch" class="px-3 py-2 rounded bg-emerald-500 text-white">Go</button>
            <button id="btnSeed" class="px-3 py-2 rounded bg-sky-500 text-white" title="Seed demo partners">Seed Demo Partners</button>
          </div>
        </div>

        <div class="card p-4 rounded shadow flex flex-col gap-3">
          <h3 class="font-semibold">Nearby Partners</h3>
          <div id="nearbyList" class="grid grid-cols-1 gap-2"></div>
        </div>

        <div class="card p-4 rounded shadow">
          <h3 class="font-semibold">Create Delivery Request (Client)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
            <input id="pickup" placeholder="Pickup address (lat,lng)" class="border px-3 py-2 rounded" />
            <input id="dropoff" placeholder="Dropoff address (lat,lng)" class="border px-3 py-2 rounded" />
            <input id="weight" placeholder="Weight (kg)" class="border px-3 py-2 rounded" />
            <textarea id="notes" placeholder="Notes (fragile...)" class="border px-3 py-2 rounded md:col-span-3"></textarea>
            <button id="btnRequest" class="md:col-span-3 px-3 py-2 rounded bg-indigo-600 text-white">Request Delivery</button>
          </div>
        </div>
      </section>

      <!-- Right column: Partner Panel -->
      <aside class="space-y-4">
        <div class="card p-4 rounded shadow">
          <h3 class="font-semibold">Partner Sign-up / Settings</h3>
          <form id="partnerForm" class="mt-3 grid gap-2">
            <input id="pname" placeholder="Partner name" class="border px-3 py-2 rounded" required />
            <input id="pcontact" placeholder="Contact number" class="border px-3 py-2 rounded" />
            <input id="plat" placeholder="Latitude" class="border px-3 py-2 rounded" />
            <input id="plng" placeholder="Longitude" class="border px-3 py-2 rounded" />
            <input id="pcapacity" placeholder="Capacity (kg)" class="border px-3 py-2 rounded" />
            <div class="flex gap-2">
              <button type="submit" class="px-3 py-2 rounded bg-emerald-600 text-white">Register Partner</button>
              <button id="btnLoadPartners" type="button" class="px-3 py-2 rounded border">Load Partners</button>
            </div>
          </form>
        </div>

        <div class="card p-4 rounded shadow">
          <h3 class="font-semibold">Dashboard / Orders</h3>
          <div id="ordersList" class="mt-3 space-y-2 tiny"></div>
        </div>

        <div class="card p-4 rounded shadow">
          <h3 class="font-semibold">Admin — Commission</h3>
          <div class="mt-2 flex gap-2 items-center">
            <input id="commissionInput" type="number" min="0" max="100" step="0.1" class="border px-3 py-2 rounded w-24" />
            <button id="btnSetComm" class="px-3 py-2 rounded bg-yellow-500">Set %</button>
          </div>
          <p class="tiny mt-2">Lower commission helps partners and keeps platform competitive.</p>
        </div>
      </aside>
    </main>

    <footer class="mt-6 text-center tiny">Demo app • Save this file as <code>local-delivery-dashboard.html</code> and open in a browser. Customize backend endpoints where marked in code.</footer>
  </div>

  <script>
  /* ------------------------
     Simple in-browser demo app
     ------------------------ */
  // Utilities
  function haversineKm(a,b){
    const toRad = d=>d*Math.PI/180;
    const R = 6371;
    const dLat = toRad(b.lat-a.lat);
    const dLon = toRad(b.lng-a.lng);
    const la = toRad(a.lat), lb = toRad(b.lat);
    const h = Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(h));
  }

  // Persistence keys
  const KEY_PARTNERS = 'ld_partners_v1';
  const KEY_ORDERS = 'ld_orders_v1';
  const KEY_COMMS = 'ld_commission_v1';

  // default commission
  let commissionPercent = parseFloat(localStorage.getItem(KEY_COMMS) || '5');
  document.getElementById('commissionLabel').innerText = commissionPercent + '%';
  document.getElementById('commissionInput').value = commissionPercent;

  // load partners from localStorage
  function loadPartners(){
    return JSON.parse(localStorage.getItem(KEY_PARTNERS) || '[]');
  }
  function savePartners(list){ localStorage.setItem(KEY_PARTNERS, JSON.stringify(list)); }

  function loadOrders(){ return JSON.parse(localStorage.getItem(KEY_ORDERS) || '[]'); }
  function saveOrders(list){ localStorage.setItem(KEY_ORDERS, JSON.stringify(list)); renderOrders(); }

  // seed demo partners
  function seedPartners(){
    const demo = [
      {id:1,name:'Ravi',contact:'+91-90000',lat:12.9716,lng:77.5946,capacity:50,active:true},
      {id:2,name:'Sita',contact:'+91-90001',lat:12.9750,lng:77.59,capacity:30,active:true},
      {id:3,name:'Arun',contact:'+91-90002',lat:12.9600,lng:77.58,capacity:80,active:true}
    ];
    savePartners(demo);
    alert('Seeded '+demo.length+' demo partners');
    renderNearby(currentLocation || {lat:12.9716,lng:77.5946});
  }

  // map setup
  const map = L.map('map').setView([12.9716,77.5946], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
  let markers = [];
  let currentLocation = null;

  function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers = []; }

  function renderNearby(center){
    clearMarkers();
    const partners = loadPartners();
    // show center marker
    const cmark = L.marker([center.lat, center.lng]).addTo(map).bindPopup('You / Search center');
    markers.push(cmark);
    // sort by distance
    partners.forEach(p=>{ p._dist = haversineKm(center, {lat:p.lat,lng:p.lng}); });
    partners.sort((a,b)=>a._dist-b._dist);
    const list = document.getElementById('nearbyList'); list.innerHTML = '';
    partners.slice(0,20).forEach(p=>{
      const el = document.createElement('div');
      el.className = 'p-3 rounded border flex items-center justify-between';
      el.innerHTML = `
        <div>
          <div class="font-semibold">${p.name} <span class="tiny">(${p.contact||'—'})</span></div>
          <div class="tiny">${p._dist.toFixed(2)} km • Capacity ${p.capacity}kg</div>
        </div>
        <div class="flex gap-2">
          <button class="px-2 py-1 rounded border tiny" onclick='showOnMap(${p.lat},${p.lng})'>Map</button>
          <button class="px-2 py-1 rounded bg-indigo-600 text-white tiny" onclick='sendOffer(${p.id})'>Send Offer</button>
        </div>
      `;
      list.appendChild(el);
      const mark = L.marker([p.lat,p.lng]).addTo(map).bindPopup(`${p.name} — ${p._dist.toFixed(2)} km`);
      markers.push(mark);
    });
    map.setView([center.lat, center.lng], 13);
  }

  window.showOnMap = (lat,lng)=>{ map.setView([lat,lng],15); };

  // sendOffer triggers creating a tentative order and notifying partner (demo)
  window.sendOffer = (pid)=>{
    const partners = loadPartners();
    const p = partners.find(x=>x.id===pid);
    if(!p) return alert('Partner not found');
    const price = prompt('Enter delivery price offer (₹) — platform will show commission after', '80');
    if(!price) return;
    const comm = (parseFloat(price) * commissionPercent/100).toFixed(2);
    const payout = (parseFloat(price) - parseFloat(comm)).toFixed(2);
    const orders = loadOrders();
    const order = { id:Date.now(), partnerId:pid, partnerName:p.name, price:parseFloat(price), commission:parseFloat(comm), payout:parseFloat(payout), status:'offered', ts:new Date().toISOString() };
    orders.unshift(order); saveOrders(orders);
    alert(`Offer sent to ${p.name}. Commission ${comm} • Partner payout ₹${payout}`);
  }

  // orders
  function renderOrders(){
    const list = document.getElementById('ordersList'); list.innerHTML='';
    const orders = loadOrders();
    if(orders.length===0) list.innerHTML = '<div class="tiny">No orders yet</div>';
    orders.slice(0,20).forEach(o=>{
      const d = document.createElement('div');
      d.className='p-2 border rounded';
      d.innerHTML = `<div class='font-semibold'>Order ${o.id}</div>
      <div class='tiny'>Partner: ${o.partnerName || '—'} • Price ₹${o.price} • Commission ₹${o.commission} • Payout ₹${o.payout}</div>
      <div class='mt-2 flex gap-2'>
        ${o.status==='offered'?`<button class='px-2 py-1 rounded bg-green-600 text-white tiny' onclick='acceptOrder(${o.id})'>Accept</button>`:''}
        ${o.status!=='cancelled'?`<button class='px-2 py-1 rounded border tiny' onclick='cancelOrder(${o.id})'>Cancel</button>`:''}
        <span class='tiny'>Status: ${o.status}</span>
      </div>`;
      list.appendChild(d);
    });
  }

  window.acceptOrder = (oid)=>{
    const orders = loadOrders();
    const o = orders.find(x=>x.id===oid);
    if(!o) return alert('Order not found');
    o.status = 'accepted'; saveOrders(orders);
    alert('Order accepted — notify client (demo)');
  }
  window.cancelOrder = (oid)=>{
    const orders = loadOrders(); const o = orders.find(x=>x.id===oid); if(!o) return;
    o.status = 'cancelled'; saveOrders(orders);
  }

  // partner sign-up
  document.getElementById('partnerForm').addEventListener('submit', e=>{
    e.preventDefault();
    const partners = loadPartners();
    const p = {
      id: Date.now(),
      name: document.getElementById('pname').value || 'NoName',
      contact: document.getElementById('pcontact').value || '',
      lat: parseFloat(document.getElementById('plat').value) || (currentLocation?currentLocation.lat:12.9716),
      lng: parseFloat(document.getElementById('plng').value) || (currentLocation?currentLocation.lng:77.5946),
      capacity: parseFloat(document.getElementById('pcapacity').value)||30,
      active:true
    };
    partners.push(p); savePartners(partners); alert('Partner registered: '+p.name); renderNearby(currentLocation || {lat:p.lat,lng:p.lng});
  });

  document.getElementById('btnLoadPartners').addEventListener('click', ()=>{ renderNearby(currentLocation || {lat:12.9716,lng:77.5946}); });
  document.getElementById('btnSeed').addEventListener('click', seedPartners);

  // locate user
  document.getElementById('btnLocate').addEventListener('click', ()=>{
    if(!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(pos=>{
      currentLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};
      renderNearby(currentLocation);
    }, err=>alert('Could not get location: '+err.message));
  });

  document.getElementById('btnSearch').addEventListener('click', ()=>{
    const v = document.getElementById('searchAddr').value.trim();
    if(!v) return alert('Enter lat,lng');
    const parts = v.split(',').map(s=>parseFloat(s.trim()));
    if(parts.length<2 || isNaN(parts[0]) || isNaN(parts[1])) return alert('Invalid format');
    currentLocation = {lat:parts[0], lng:parts[1]}; renderNearby(currentLocation);
  });

  // request delivery (client)
  document.getElementById('btnRequest').addEventListener('click', ()=>{
    const pickup = document.getElementById('pickup').value.trim();
    const dropoff = document.getElementById('dropoff').value.trim();
    if(!pickup || !dropoff) return alert('Enter pickup and dropoff (lat,lng)');
    const pparts = pickup.split(',').map(x=>parseFloat(x.trim()));
    const dparts = dropoff.split(',').map(x=>parseFloat(x.trim()));
    if(pparts.length<2 || dparts.length<2) return alert('Invalid lat,lng format');
    const dist = haversineKm({lat:pparts[0],lng:pparts[1]},{lat:dparts[0],lng:dparts[1]});
    // price model: base + per-km + weight factor
    const weight = parseFloat(document.getElementById('weight').value) || 1;
    const base = 30; const perKm = 10; const price = Math.max(40, Math.round((base + perKm*dist + weight*5)));
    const comm = +(price * commissionPercent/100).toFixed(2);
    const payout = +(price - comm).toFixed(2);
    const orders = loadOrders();
    const order = { id:Date.now(), pickup, dropoff, distanceKm:+dist.toFixed(2), weight, price, commission:comm, payout, status:'open', ts:new Date().toISOString() };
    orders.unshift(order); saveOrders(orders);
    alert(`Delivery request created. Estimated price ₹${price}. Commission ₹${comm}. Platform payout (collected) ₹${price}.`);
    renderOrders();
  });

  // commission set
  document.getElementById('btnSetComm').addEventListener('click', ()=>{
    const v = parseFloat(document.getElementById('commissionInput').value);
    if(isNaN(v) || v<0) return alert('Enter valid percent');
    commissionPercent = v; localStorage.setItem(KEY_COMMS, v); document.getElementById('commissionLabel').innerText = v + '%';
    alert('Commission updated to '+v+'%');
    renderOrders();
  });

  // toggle panel button (simple switch between partner/client focus)
  document.getElementById('btnTogglePanel').addEventListener('click', ()=>{
    document.querySelectorAll('aside, section').forEach(el=>el.classList.toggle('hidden'));
    document.getElementById('btnTogglePanel').innerText = document.querySelector('aside').classList.contains('hidden') ? 'Show Partner' : 'Partner / Client Panel';
  });

  // initial render
  renderOrders(); renderNearby({lat:12.9716,lng:77.5946});

  // Placeholder: where to integrate backend
  /*
    TODO BACKEND INTEGRATION
    - Replace localStorage functions loadPartners/savePartners, loadOrders/saveOrders with API calls:
      fetch('/api/partners') etc.
    - Use authentication for partners (JWT), role based views.
    - Use real geocoding / reverse geocoding (Nominatim or Google Geocode) for readable addresses.
    - Push notifications & SMS: integrate Firebase Cloud Messaging and an SMS gateway.
    - Payment & payouts: integrate Razorpay / Stripe for collecting payments and payouts to partners.
  */
  </script>
</body>
</html>
